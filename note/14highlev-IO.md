#14  高级IO

* **阻塞IO与非阻塞IO**

1）阻塞IO是指在等待IO操作时不能进行其他操作，只能等待。比如，如果遇到读取数据不存在的文件，那么可能会使进程永远阻塞，其他可以运行的线程也无法运行。
2）非阻塞IO是指，不会使得进程因为IO操作永远阻塞，在等待IO时可以去做其他事情。

* **记录锁**：我觉得又可称为局部锁

现在的互斥锁，读写锁，自旋锁等都只能对变量或者一整个文件加锁，如果文件太大，又有多个进程需要修改文件的多个部分，那么就可使用记录锁，也就是对文件的局部进行加锁。未加锁区域是允许其他进程访问的。

* **IO多路转接**：select，poll

如果我们需要进行多个IO，如果使用阻塞IO，其中一个IO暂时还没有准备好，而我们此时正在等待它，那么其他已经准备好的IO也无法进行
所以我们需要使用非阻塞IO，IO多路转接提供了一种非阻塞IO的方式
**实现方式**：
先构造一张（poll）或多张（select）我们感兴趣的文件描述符表，然后调用一个函数，知道这些描述符中的一个已准备好IO，才返回。返回时，进程会被告知哪些描述符可以进行IO了。

* **select**

传给内核的参数告诉内核：
1）我们所关心的描述符，
2）对于每个描述符我们所关心的条件，
3）愿意等待多长时间。
返回时内核告诉我们：
1）已经准备好的描述符的总数量，
2）哪些描述符已经准备好了。

```
#include <sys/select.h>
int select(int maxfdp1, 
		  fd_set *restrict readfds, 
		  fd_set *restrict writefds,
		  fd_set *restrict exceptfds,
		  struct timeval *restrict tvptr);
返回值：返回-1，表示出错，此时不会修改描述符集
	   返回0，表示时间到了，还没有描述符准备好，此时会把描述符集清零
	   返回大于0的整数，表示已准备好的描述符的总数量，对应的描述符集仍然打开的描述符表示已准备好的描述符
参数1：表示所有感兴趣的描述符中描述符号最大的值+1
参数2：指向关心的可读描述符集的指针，若不关心为NULL
参数3：指向关心的可写描述符集的指针，若不关心为NULL
参数4：指向关心的异常描述符集的指针，若不关心为NULL
参数5：表示愿意等待的相对时间，比如5.4秒
```

* **poll**

poll函数类似select，但是程序接口不同，poll函数可用于任何类型的描述符

```
#include <sys/poll.h>
int poll(struct pollfd fdarray[], nfds_t, int timeout);
返回值：返回-1，表示出错
	   返回0，表示超时了还没有描述符准备好了
	   返回大于0的整数，表示已准备好的描述符的数量
参数1：指向一个pollfd的我们感兴趣的描述符数组
参数2：描述符集中描述符的数量
参数3：超时时间

strcut pollfd
{
	int fd;           //关心的描述符号 
	short events;     //我们关心它的什么事件
	short revents;    //如果发生了事件，用什么返回
};
```

* **同步/异步/阻塞/非阻塞**

**同步/异步**：指的是事件发生后，是自己去检查，还是通知你
同步：当事件发生后，你得自己去检查事件有没有发生，比如轮询
异步：事件发生后，会通知你，不需要自己去检查

**阻塞/非阻塞**：指的是等待事件发生时，你能否做其他事情
阻塞：等待事件发生时，不能做其他事情，进程被阻塞
非阻塞：等待事情发生时，可以做其他事情，进程不会被阻塞

**同步阻塞**
一直在检查事件发生有没有发生，而且不能做别的事情

**同步非阻塞**
大部分时间在做其他事情，偶尔自己检查一下事件发生了没

**异步非阻塞**
所有时间都在做其他事情，事件发生了，会通知你

* **异步IO**
select/poll需要主动查询状态，系统不会主动通知你
异步IO使用信号通知进程，你关心的事件已经发生
aio















