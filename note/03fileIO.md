# 03. 文件IO
Unix大多数IO只需要用到５个函数
**open, close, read, write, lseek**
这些是系统调用，又称为不带缓存IO，指的是在进程空间不使用缓存，但是在内核还是有缓存的，因为系统对磁盘的读写都会提供内核缓存（又称为高速缓存），写入磁盘时先写入内核缓存，之后再集中写入磁盘．
标准IO又称为带缓存的IO，因为它在进程空间还会使用缓存，底层实现也是调用系统调用，标准IO的目的就是减少使用系统调用的次数，以提高效率．

- **文件描述符**
所有打开文件都通过文件描述符来引用
当打开或创建一个文件时，返回一个文件描述符
０，标准输入，STDIN_FILENO
１，标准输出，STDOUT_FILENO
２，标准错误，STDERR_FILENO
这些常量在<unistd.h\>中定义

- **open，openat**
```
#include <fcntl.h>
int open(const char* path, int oflag, ....);
int openat(int fd, const char* path, int oflag, ....);
调用成功，返回文件描述符，若出错，返回-1
```
path ：文件路径
oflag：各种打开参数，典型的如：
O_RDONLY		只读打开	
O_WRONLY	只写打开
O_RDWR　　　 读写打开
...
open只能打开绝对路径的文件
openat可以打开相对路径的文件，fd参数就是用于此

- **close**
```
int close(int fd);
调用成功，返回０，调用失败，返回-1
```
关闭一个文件会释放加在该文件上的所有记录锁
当一个进程终止时，内核自动关闭它所有打开的文件


- **lseek**
每个文件都有一个当前文件偏移量，用于度量从文件开始处计算的字节数
```
#include <unitad.h>
off_t lseek(int fd, off_t offset, int where);
调用成功返回文件的新偏移量，调用失败返回-1
```
offset：用于指定此次移动的偏移量，可正可负
where：一共有三种参数
SEEK_SET：表示从文件开始位置起
SEEK_CUR：表示从文件当前位置开始
SEEK_END：表示从文件末尾开始

- **read**
```
#include <unistd.h>
ssize_t read(int fd, void* buf, size_t nbytes);
调用成功返回读取的字节数
若读取的字节数小于nbytes（比如读取到文件末尾了）返回０
调用失败返回-1
```
size_t：不带符号，大于等于０
ssize_t：带符号，可正可负

- **write**
```
#include <unistd.h>
ssize_t write(int fd, const void* buf, size_t nbytes);
写入成功返回写入的字节数
写入失败返回-1
```

- **creat**
```
#include <fcntl.h>
int creat(const char* path, mode_t mode)
创建一个只写的新文件，若成功，返回只写文件描述符，若出错，返回-1
```

- **内核使用三数据结构来表示打开的文件**
１．proc进程表项中的fd表
*背景知识：（每一个进程都有一个PCB，PCB是进程存在的唯一标识
PCB分为两部分，user部分 和 proc部分
user部分只包含进程被CPU执行时所需要的信息，所以只有当运行时才会被调入内存
proc部分包含进程调用所需信息，所以一直放在内存
这么做的原因是节省内存空间）*
proc进程表项部分都有一个记录本进程打开的文件描述符的表，包含文件描述符和指向此文件表的指针
２．fd表中指针指向的文件表项
内核为所有打开的文件维护一张文件表（但是每个进程维护本进程打开的文件表项）
，包含每个文件状态，当前偏移量，以及v节点指针
３．
每个打开的文件或设备都有一个v节点结构，包含文件类型，i节点等信息
**如果进程１与进程２打开了同一个文件，那么会有两个文件表项，只会有一个v节点**

- **原子操作**
由于多步操作（比如系统调用）可能会被中途打断，此时可能会产生非预期的结果
所以需要一种不会被打断的操作
原子操作是指由多步组成的一个操作，该操作原子的执行，要么执行完所有步骤，要么一步也不执行

- **文件共享dup，dup2**
下面两个函数用来复制一个现有的文件描述符
```
#include <unistd.h>
int dup(int fd);
int dup2(int fd1, int fd2);
调用成功返回新的文件描述符，调用失败返回-1
```
dup函数返回的新文件描述符，是目前可用且最小的那个
dup2函数用于指定返回的新文件描述符，如果那个文件描述符已被占用，则将那个文件关闭，如果fd1 == fd2，则不关闭，直接返回fd2

- **sync，fsync**
背景：内核为文件IO留有一段高速缓存．当写入文件时，先把数据复制到高速缓存，过些时候才会真正写入磁盘．这样的话就会造成缓存区的文件与磁盘的文件不一致．为了保持一致性，可使用sync，fsync
```
#include <unistd.h>
int fsync(int fd);
int sync(void);
调用成功会返回０，失败返回-1
```
sync是同步高速缓存区中所有的数据，写入到磁盘
fsync是只同步指定fd的文件，写入到磁盘
- ****

